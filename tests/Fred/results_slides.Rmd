---
title: "ThreeME Standard results"
subtitle: "Scenario: `r params$scenario_name`"
author: "ThreeME team"
date: "`r format(Sys.Date(), '%d %B %y')`"
output: slidy_presentation
params:
  startyear: 2020
  endyear: 2050
  scenario_name: carbontax_lux
  classification: c25_s29
  template_default: ofce
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = "hide"
)
```


```{r Plots default options}


startyear <- params$startyear
endyear <- params$endyear
scenario_name <- params$scenario_name
classification <- params$classification
template_default <- params$template_default

```



```{r Required packages, message=FALSE, warning=FALSE}

# Load functions
source("src/functions.R")


```


```{r load data and bridges}

data_full<-readRDS(file = paste0("databases/",scenario_name,"_",classification,".rds"))
### loading the sector and commodity aggregated database 
data_sector <- readRDS(file = paste0("databases/",scenario_name,"_",classification,"_commodities_sectors.rds"))


source(paste0("bridges/bridge_",classification,".R"))
source(paste0("bridges/codenames_",classification,".R"))



```

---

# Result summary

```{r Table macro, results ='asis'}

table <- ermeeth::table.output(data = data_sector, scenario = scenario_name, 
             full.table = FALSE, export.doc = FALSE, langue = "en",
             title = 'Macroeconomic main results')

table

# to do: 
# - Unité pas claire unclear: %, unit?
# - manque des indicateurs:  taux de chomage
# - Légend (a) inutile car toute les même: seulement pour les exceptions
# - a 2nd tables with the missing indicators


```

---

# Macroeconomic results: GDP and its components

```{r Graph GDP,  fig.height = 6, fig.width = 14}
label_macro <- c("Gross domestic product", "Households consumption", "Investment", "Public spending")
A <- simpleplot(data_full,c("GDP", "CH", "I", "G"), label_macro, startyear, endyear, titleplot = "GDP and its components  (in difference from baseline)")

B <- simpleplot(data_full,c("X", "M", "BAL_TRADE"),label_series = c("Exports", "Imports", "Trade balance"), startyear, endyear, titleplot = "External trade  (in difference from baseline)")


macro <- ggarrange(A,B,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

## Save image on disk for further use (ready to be activated)
# ggsave("macro.svg", device = svg, width = 32,  height = 16, units = c("cm"))


## See the graph in Mark-down
macro


```


---

# GDP and its components (Growth rate)
```{r Graph Macro Growth rate, fig.height = 6, fig.width=14}

A <- simpleplot(data_full,c("GDP", "CH", "I", "G"), label_macro, startyear, endyear, "gr", titleplot = "GDP and its components (growth rates)")

B <- simpleplot(data_full,c("X", "M"), c("Exports", "Imports"), startyear, endyear, "gr", titleplot = "External trade (growth rates)")

ggarrange(A,B,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

```

# Contribution to the GDP change relative to the baseline
```{r contrib Graphs, fig.height=6, fig.width=12}

GDP_comp <- c( "CH","BAL_TRADE", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Trade balance", "Investment", "Public spending","Stock variation")

data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline",scenario_name))

contrib.plot(data_plot, series = GDP_comp,label_series = GDP_comp_label,
             startyear = 2020, titleplot = "Contributions to GDP change (in difference from baseline)", line_tot = TRUE)



```


```{r contrib Graphs PAUL, eval=FALSE, fig.height=6, fig.width=12, include=FALSE}
#filter(data_full, variable == "BAL_TRADE")
#157883.7 - 131631.8
#M 131631.8
#X 157883.7 
#BAL 26747.98
GDP_comp <- c( "CH","BAL_TRADE", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Trade balance", "Investment", "Public spending","Stock variation")
data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline",scenario_name), indicator = "rel.diff")
contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020,
             titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)
GDP_comp <- c( "CH","X","M", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Exports", "Imports", "Investment", "Public spending","Stock variation")
data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline"),
                      indicator = "gr.diff", neg.value = "M")
contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020,
             titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)
```


```{r contrib Graphs_example, eval=FALSE, fig.height=6, fig.width=12, include=FALSE}


GDP_comp <- c( "CH","BAL_TRADE", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Trade balance", "Investment", "Public spending","Stock variation")

data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline",scenario_name), indicator = "rel.diff")

contrib.plot(data_plot, series = GDP_comp,label_series = GDP_comp_label,
             startyear = 2020, titleplot = "Contributions to GDP change (in difference from baseline)", line_tot = TRUE)

contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020,
             titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)

GDP_comp <- c( "CH","X","M", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Exports", "Imports", "Investment", "Public spending","Stock variation")

data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline"),
                      indicator = "gr.diff", neg.value = "M")

contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020,
             titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)




#filter(data_full, variable == "BAL_TRADE")


#157883.7 - 131631.8
#M 131631.8
#X 157883.7 
#BAL 26747.98



data_plot <-  contrib(data_full,"BAL_TRADE", c("X", "M"), scenar = c("baseline",scenario_name),
                      indicator = "rel.diff", neg.value = "M")

contrib.plot(data_plot, series = c("X", "M"),
             startyear = 2020,
             titleplot = "Contributions to trade surplus (in difference from baseline)", line_tot = TRUE)


## GDP 1

data_plot <-  contrib(data_full,"CH", c("CHD", "CHM"), scenar = c("baseline",scenario_name), indicator = "share")

contrib.plot(data_plot, series = c("CHD", "CHM"),
             startyear = 2020,
             titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)

GDP_comp <- c( "CH","X", "M", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Trade balance", "Investment", "Public spending","Stock variation")

data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline",scenario_name), indicator = "rel.diff", neg.value = "M")

contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020, titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)

GDP_comp <- c( "X", "M")
GDP_comp_label <- c("Exports", "Imports")

data_plot <-  contrib(data_full,"BAL_TRADE", GDP_comp, scenar = c("baseline",scenario_name), indicator = "rel.diff", neg.value = "M")

contrib.plot(data_plot, series = GDP_comp,
             startyear = 2020, titleplot = "Contributions to Balance of trade gowth (in difference from baseline)", line_tot = TRUE)



```


```{r Contrib OLD, eval=FALSE, include=FALSE}

GDP_comp <- c( "CH","X","M", "I", "G","DS")
GDP_comp_label <- c( "Households consumption","Exports","Imports", "Investment", "Public spending","Stock variation")

data_plot <-  contrib(data_full,"GDP", GDP_comp, scenar = c("baseline",scenario_name))

contrib.plot(data_plot, series = GDP_comp,label_series = GDP_comp_label,
             startyear = 2020, titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)


# To do: graphique faux!!!  


```

```{r Contrib Trade Balance, eval=FALSE, include=FALSE}

## BUG: Function contrib:
## - GDP hard codé  ligne 119 et 170
## - Il ne faut pas mettre M par default en négatif car pb si on ne veux pas que M soit négatif


GDP_comp <- c("X","M")
GDP_comp_label <- c("Exports","Imports")

data_plot <-  contrib(data_full,"BAL_TRADE", GDP_comp, scenar = c("baseline",scenario_name))

contrib.plot(data_plot, series = GDP_comp,label_series = GDP_comp_label,
             startyear = 2020, titleplot = "Contributions to GDP gowth (in difference from baseline)", line_tot = TRUE)





```



```{r Test format DF, eval=FALSE, include=FALSE}

scenarios <- c("carbontax_lux","baseline")

selection <- data_full %>% dplyr::filter(variable %in%  c("GDP","CH", "G", "I", "DS"))
  
  
  
selection_wide  <- selection %>% 
                                        tidyr::pivot_wider(
                                        id_cols = year ,
                                        names_from = variable, 
                                        names_sep = "." ,
                                        values_from = c(carbontax_lux,baseline) )  
selection_wide2 <- selection_wide  %>%

                                     mutate(carbontax_lux.CH_G = carbontax_lux.CH + carbontax_lux.G,
                                            baseline.CH_G = baseline.CH + baseline.G,
                                            carbontax_lux.I_DS = carbontax_lux.I + carbontax_lux.DS,
                                            baseline.I_DS = baseline.I + baseline.DS
                                            
                                            )
  


selection_wide2bis <- scenarios %>% map(~selection_wide %>% 
                                     mutate(!!paste0(.x,".","CH_G") := get(paste0(.x,".","CH")) + get(paste0(.x,".","G"))
                                            ) %>%
                                     select(year, all_of(setdiff(names(.),names(selection_wide))))
                                   ) %>% 
  reduce(full_join) %>% full_join(selection_wide)




```

---


# Employment

```{r Employment, fig.height = 6, fig.width=14}

A <- simpleplot(data_full,"F_L", label_series = "Labor", startyear, endyear, decimal = 1, titleplot = "Employment (in difference from baseline)")
B <- simpleplot(data_full,"F_L", label_series = "Labor", startyear, endyear, "diff", unit = 1000, decimal = 1, titleplot = "Employment (in difference from baseline)")

ggarrange(A,B,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

```

---


# Unemployment

```{r Unemployment, fig.height = 6, fig.width=14}

C <- simpleplot(data_full,"UNR", label_series = "Unemployment", startyear, endyear,"diff", unit = 100, titleplot = "Unemployment rate (in difference from baseline)")
D <- simpleplot(data_full,"UNR", label_series = "Unemployment rate (dashed line = baseline)", startyear, endyear, "level", titleplot = "Unemployment rate  (level)")

ggarrange(C,D,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

```

# Prices and wages 

```{r Graph Prices, fig.height = 6, fig.width=14}
label_prices <- c("Consumption", "Production", "Value added","Imports", "Exports")
A <- simpleplot(data_full,c("PCH", "PY", "PVA", "PM", "PX"),label_prices, startyear, endyear, titleplot = "Prices (in difference from baseline)")
B <- simpleplot(data_full,"W", label_series = "wage", startyear, endyear, titleplot = "Gross nominal wages (in difference from baseline)")

prix_salaires <- ggarrange(A,B,
                           labels = c("(a)", "(b)"),
                           hjust =-0.5, vjust = 1.5,
                           ncol = 2, nrow = 1,
                           widths = 2,  heights = 1)
prix_salaires
```


---

# Sectoral results: Production and the value added

```{r ProdVA2, fig.height = 6, fig.width=14}

B <- curve_sc_plot(data_sector,"Y", growth.rate = FALSE,diff = TRUE,abs.diff = FALSE, title = "Production by sector (in difference from baseline)")

C <- curve_sc_plot(data_sector,"VA",diff=TRUE,growth.rate = FALSE,abs.diff = FALSE,title = " Added value by sector (in difference from baseline)")

ggarrange(B,C,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)


```


---

# Sectoral employment

```{r Sectoral eployment, eval=FALSE, fig.height=6, fig.width=14, include=FALSE}

C <- simpleplot(data_full,"UNR", label_series = "Unemployment", startyear, endyear,"diff", unit = 100, titleplot = "Unemployment rate (in difference from baseline)")
D <- simpleplot(data_full,"F_L", label_series = "Labor", startyear, endyear, "diff", unit = 1000, decimal = 1, titleplot = "Employment (in difference from baseline)")

E<- curve_sc_plot(data_sector,"F_L",diff=TRUE,abs.diff = TRUE,title = "Employment by sector (in difference from baseline)")
G <- simpleplot(data_full,"UNR","Unemployment rate", startyear, endyear, "level", titleplot = "Unemployment rate ")
ggarrange(C,D,G,E,
labels = c("(a)", "(b)", "(c)", "(d)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 2,
widths = 2,  heights = 1)

```





