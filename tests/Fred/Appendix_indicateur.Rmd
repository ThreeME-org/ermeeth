---
title: "ThreeME Standard results"
author: "ThreeME team"
date: "`r format(Sys.Date(), '%d %B %y')`"
output: slidy_presentation
# output:
#   ioslides_presentation: default
#   slidy_presentation: default
subtitle: 'Scenario: `r params$scenario_name`'
params:
  startyear: 2020
  endyear: 2050
  scenario_name: carbontax_lux
  
  classification: c25_s26
  template_default: ofce
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = "hide"
)
```


```{r Plots default options}


startyear <- params$startyear
endyear <- params$endyear
scenario_name <- params$scenario_name
classification <- params$classification
template_default <- params$template_default

```



```{r Required packages, message=FALSE, warning=FALSE}

# Load functions
source("src/functions.R")


```




```{r Create database function, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# Create the database for further processing
source("src/0_create_databases.R")

```





```{r load data and bridges}

data_full<-readRDS(file = paste0("databases/",scenario_name,"_",classification,".rds"))
### loading the sector and commodity aggregated database 
data_sector <- readRDS(file = paste0("databases/",scenario_name,"_",classification,"_commodities_sectors.rds"))


source(paste0("bridges/bridge_",classification,".R"))
source(paste0("bridges/codenames_",classification,".R"))




```

---

# GHG emissions: decomposition per source

```{r GHG emissions per source, fig.height=6, fig.width=14}


variables_selection <-   c(  variables_like(data_sector,"^EMS_CI_C0",FALSE),
                             variables_like(data_sector,"^EMS_CH_C0",FALSE),   
                             "EMS_CI", "EMS_CH"  )

calcul_indic <- function(data){
   res <- data
   res <- mutate(res,     
          EMS_CI_CH = EMS_CI + EMS_CH)

 for (i in c(1:8)){

   if(exists(paste0("EMS_CI_C00",i), data ) & exists(paste0("EMS_CH_C00",i), data )  ){   
     res <- mutate(res,
                !!paste0("EMS_CI_CH_C00",i) := get(paste0("EMS_CI_C00",i)) + get(paste0("EMS_CH_C00",i)) ) 
   }

   if(exists(paste0("EMS_CI_C00",i), data ) & !exists(paste0("EMS_CH_C00",i), data )  ){   
     res <- mutate(res,
                !!paste0("EMS_CI_CH_C00",i) := get(paste0("EMS_CI_C00",i))  ) 
   }
   
   
   if(!exists(paste0("EMS_CI_C00",i), data ) & exists(paste0("EMS_CH_C00",i), data )  ){   
     res <- mutate(res,
                !!paste0("EMS_CI_CH_C00",i) :=  get(paste0("EMS_CH_C00",i)) ) 
   }
      
   
   
 }

    return(res)
  
}


new_indicators <- data_sector %>%  dplyr::filter(variable %in% variables_selection) %>% 
  # 1. Put in Wide format
  wide_data(variables = variables_selection , out_format = "list") %>%  ## 1. passe en wide
  # 2. Calculate indicators
  map(~calcul_indic(.x)) %>% 
  long_data()


A <- curve_sc_plot(new_indicators,"EMS_CI_CH", startyear = startyear, endyear = endyear, group_type = "C", growth.rate = FALSE,diff = TRUE,abs.diff = FALSE, title = "GHG emissions per source (in difference from baseline)")

data_plot <- contrib.sub(new_indicators,var1 =  "EMS_CI_CH",
group_type = "C", scenar = c("baseline", scenario_name))

B <- contrib.sub.plot(data_plot, template = "ofce", startyear = startyear, endyear = endyear, line_tot =  TRUE, titleplot = "Contributions to changes in GHG emissions (in difference from baseline)")

ggarrange(A,B,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

```

```{r version Anissa To avoid for loop: STEP BY STEP, eval=FALSE, include=FALSE}
# 
# ### 0. Data base for testing purposes
# variables_selection <-   c(  variables_like(new_indicators_bis,"^EMS_CI_C0",FALSE),
#                              variables_like(new_indicators_bis,"^EMS_CH_C0",FALSE),
#                              "EMS_CI", "EMS_CH"  )
# list_data <- new_indicators_bis %>% wide_data(variables = variables_selection , out_format = "list")
# data <- list_data$baseline
# 
# 
# ### 1. Start by creating a list of commodity where calculation is possible
# 
# existing_commodities_CI <- names(data)[grep(pattern = "^EMS_CI_C\\d{3}$" , x= names(data))] %>%
#   str_extract("C\\d{3}$")
# existing_commodities_CH <- names(data)[grep(pattern = "^EMS_CH_C\\d{3}$" , x= names(data))] %>%
#   str_extract("C\\d{3}$")
# 
# existing_commodities <- unique(c(existing_commodities_CI,existing_commodities_CH))
# 
# ### 2.A  Version A : WORKS IF BOTH CH AND CI ARE PRESENT
# 
# compute_EMS_v0 <- function(commodity, database){
#   res <- mutate(database,
#                 !!paste0("EMS_",commodity) := get(paste0("EMS_CI_",commodity)) + get(paste0("EMS_CH_",commodity)) ) %>%
#     select(year,all_of(paste0("EMS_",commodity) ) )
#   }
# 
# data_res <- existing_commodities %>%
#   map(~compute_EMS_v0(commodity = .x, database = data) ) %>%
#   reduce(full_join,by = "year") %>%
#   full_join(data, by = "year")
# 
# ##############
# ### 2.B  Version B : WORKS IF ONE IS MISSING
# data_mod <- data %>% select(-EMS_CH_C003,-EMS_CI_C007)
# 
# compute_EMS_safe_v1 <- function(commodity, database){
# 
#   if(exists(paste0("EMS_CI_",commodity), database ) & exists(paste0("EMS_CH_",commodity), database )  ){
#   res <- mutate(database,
#                 !!paste0("EMS_",commodity) := get(paste0("EMS_CI_",commodity)) + get(paste0("EMS_CH_",commodity)) ) %>%
#     select(year,all_of(paste0("EMS_",commodity) ) ) }
# 
# 
#   if(exists(paste0("EMS_CI_",commodity), database ) & !exists(paste0("EMS_CH_",commodity), database )  ){
#     res <- mutate(database,
#                   !!paste0("EMS_",commodity) := get(paste0("EMS_CI_",commodity))  ) %>%
#       select(year,all_of(paste0("EMS_",commodity) ) ) }
# 
# 
#   if(!exists(paste0("EMS_CI_",commodity), database ) & exists(paste0("EMS_CH_",commodity), database )  ){
#     res <- mutate(database,
#                   !!paste0("EMS_",commodity) := get(paste0("EMS_CH_",commodity)) ) %>%
#       select(year,all_of(paste0("EMS_",commodity) ) ) }
# 
#   return(res)
# }
# 
# ### 2.C  Version C : WORKS FOR SUMS ONLY
# 
# compute_EMS_safe_v2 <- function(commodity, database){
# 
#  var_to_sum <- unique(c(names(database)[grep(paste0("^EMS_CI_",commodity,"$"),names(database))],
#                         names(database)[grep(paste0("^EMS_CH_",commodity,"$"),names(database))])
#                       )
# 
#  res <- mutate(database,
#                   !!paste0("EMS_",commodity) := rowSums(across(all_of(var_to_sum))) ) %>%
#       select(year,all_of(paste0("EMS_",commodity) ) )
# 
#   return(res)
# }
# 
# # ###Testeur
# # database<- data_mod
# # commodity = "C001"
# # database_test<- mutate(database, plop = rowSums(across(all_of(var_to_sum))) )
# # ###
# 
# data_res2 <- existing_commodities %>%
#   map(~compute_EMS_safe_v2(commodity = .x, database = data_mod) ) %>%
#   reduce(full_join,by = "year") %>%
#   full_join(data_mod,., by = "year")




```


```{r version Anissa Complete Solution to avoid For Loop, eval=FALSE, include=FALSE}

variables_selection <-   c(  variables_like(data_sector,"^EMS_CI_C0",FALSE),
                             variables_like(data_sector,"^EMS_CH_C0",FALSE),   
                             "EMS_CI", "EMS_CH"  )

new_indicators_bis <- data_sector %>%  dplyr::filter(variable %in% variables_selection) 
####PUTTING IT ALL TOGETHER

calcul_indic_AS <- function(database){

  ### step 1: get the commodities
existing_commodities_CI <- names(database)[grep(pattern = "^EMS_CI_C\\d{3}$" , x= names(database))] %>%
  str_extract("C\\d{3}$")
existing_commodities_CH <- names(database)[grep(pattern = "^EMS_CH_C\\d{3}$" , x= names(database))] %>%
  str_extract("C\\d{3}$")
existing_commodities <- unique(c(existing_commodities_CI,existing_commodities_CH))

  ### step 2: write de the function for the sum 
compute_EMS_safe_short <- function(commodity, data){


 var_to_sum <- unique(c(names(data)[grep(paste0("^EMS_CI_",commodity,"$"),names(data))],
                        names(data)[grep(paste0("^EMS_CH_",commodity,"$"),names(data))])
                      )

 res <- mutate(data,
                  !!paste0("EMS_CI_CH_",commodity) := rowSums(across(all_of(var_to_sum))) ) %>%
      select(year,all_of(paste0("EMS_CI_CH_",commodity) ) )

  return(res)
}

### step 3: Line for one wide data base
data_res <- existing_commodities %>%
  map(~compute_EMS_safe_short(commodity = .x, data = database) ) %>%
  reduce(full_join,by = "year") %>%
  full_join(database,., by = "year") %>% 
  ##variables independent of commodity
  mutate( EMS_CI_CH = EMS_CI + EMS_CH )

return(data_res)
}

new_indicators_vAS <-  new_indicators_bis %>% 
  # 1. Put in Wide format
  wide_data(variables = variables_selection , out_format = "list") %>%  
  # 2. Calculate indicators
  map(~calcul_indic_AS(.x)) %>% 
  # 3. Back to long data
  long_data()




A <- curve_sc_plot(new_indicators,"EMS_CI_CH", startyear = startyear, endyear = endyear, group_type = "C", growth.rate = FALSE,diff = TRUE,abs.diff = FALSE, title = "GHG emissions per source (in difference from baseline)")

data_plot <- contrib.sub(new_indicators,var1 =  "EMS_CI_CH",
group_type = "C", scenar = c("baseline", scenario_name))

B <- contrib.sub.plot(data_plot, template = "ofce", startyear = startyear, endyear = endyear, line_tot =  TRUE, titleplot = "Contributions to changes in GHG emissions (in difference from baseline)")

ggarrange(A,B,
labels = c("(a)", "(b)"),
hjust = -0.5, vjust = 1.5,
ncol = 2, nrow = 1,
widths = 2,  heights = 1)

```

