---
title: "ThreeME Standard results"
author: "ThreeME team"
date: "`r format(Sys.Date(), '%d %B %y')`"
output: slidy_presentation
# output:
#   ioslides_presentation: default
#   slidy_presentation: default
subtitle: 'Scenario: `r params$scenario_name`'
params:
  startyear: 2020
  endyear: 2050
  scenario_name: carbontax_lux
  
  classification: c25_s26
  template_default: ofce
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = "hide"
)
```


```{r Plots default options}


startyear <- params$startyear
endyear <- params$endyear
scenario_name <- params$scenario_name
classification <- params$classification
template_default <- params$template_default

```



```{r Required packages, message=FALSE, warning=FALSE}

# Load functions
source("src/functions.R")


```




```{r Create database function, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# Create the database for further processing
source("src/0_create_databases.R")

```





```{r load data and bridges}

data_full<-readRDS(file = paste0("databases/",scenario_name,"_",classification,".rds"))
### loading the sector and commodity aggregated database 
data_sector <- readRDS(file = paste0("databases/",scenario_name,"_",classification,"_commodities_sectors.rds"))


source(paste0("bridges/bridge_",classification,".R"))
source(paste0("bridges/codenames_",classification,".R"))




```


---


```{r Calculation of new indicators}

  ### step 0: prepare database
variables_selection <-   c(variables_like(data_full,"^F_L_S[A-Z0-9]{3}$",FALSE),"F_L",
                           variables_like(data_full,"^F_K_S[A-Z0-9]{3}$",FALSE),"F_K",
                           variables_like(data_full,"^F_MAT_S[A-Z0-9]{3}$",FALSE),"F_MAT",
                           variables_like(data_full,"^F_E_S[A-Z0-9]{3}$",FALSE),"F_E",
                           variables_like(data_full,"^I_S[A-Z0-9]{3}$",FALSE),"I",
                           variables_like(data_full,"^C_L_S[A-Z0-9]{3}$",FALSE),"C_L",
                           variables_like(data_full,"^C_K_S[A-Z0-9]{3}$",FALSE),"C_K",
                           variables_like(data_full,"^C_MAT_S[A-Z0-9]{3}$",FALSE),"C_MAT",
                           variables_like(data_full,"^C_E_S[A-Z0-9]{3}$",FALSE),"C_E",
                           variables_like(data_full,"^Y_S[A-Z0-9]{3}$",FALSE),"Y",
                           variables_like(data_full,"^PY_S[A-Z0-9]{3}$",FALSE),"PY",
                           variables_like(data_full,"^MGS_C[A-Z0-9]{3}$",FALSE), "MGS",
                           #only 3 commodities,"MGS_CPRI" "MGS_CRAI" "MGS_CROA"
                           variables_like(data_full,"^CI_C[A-Z0-9]{3}$",FALSE), "CI", #CCOI missing
                           variables_like(data_full,"^F_E_C[A-Z0-9]{3}$",FALSE), #doesn't existing in database
                           variables_like(data_full,"^CH_C[A-Z0-9]{3}$",FALSE),"CH",
                           variables_like(data_full,"^G_C[A-Z0-9]{3}$",FALSE), "G", #CCOI missing
                           variables_like(data_full,"^I_C[A-Z0-9]{3}$",FALSE), #CCOI missing
                           variables_like(data_full,"^X_C[A-Z0-9]{3}$",FALSE),"X", #CCOI missing
                           variables_like(data_full,"^M_C[A-Z0-9]{3}$",FALSE),"M", #CCOI missing
                           "GDP","PGDP",
                           "SPEND_G_VAL","INC_G_VAL","PNTAXC","NTAXC",
                           variables_like(data_sector,"^F_L_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^F_K_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^F_MAT_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^F_E_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^I_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^C_L_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^C_K_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^C_MAT_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^C_E_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^Y_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^PY_S[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^MGS_C[A-Z0-9]{3}$",FALSE), 
                           variables_like(data_sector,"^CI_C[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^F_E_C[A-Z0-9]{3}$",FALSE), 
                           variables_like(data_sector,"^CH_C[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^G_C[A-Z0-9]{3}$",FALSE), 
                           variables_like(data_sector,"^I_C[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^X_C[A-Z0-9]{3}$",FALSE),
                           variables_like(data_sector,"^M_C[A-Z0-9]{3}$",FALSE)
                           )

data_ratio <- rbind(dplyr::filter(data_full,variable %in% variables_selection),
                    dplyr::filter(data_sector,variable %in% variables_selection)) %>%
              unique()


  ### step 1: check and complete missing data by 0
  list_S_variable <- c("F_L","F_K","F_MAT","F_E","C_L","C_K","C_MAT","C_E","I","Y","PY") %>%
    map(~paste0(.x,"_",toupper(names_sectors[,"code"]))) %>%
    reduce(c)
  list_C_variable <- c("MGS","CI","CH","G","I","X","M","F_E") %>%
    map(~paste0(.x,"_",toupper(names_commodities[,"code"]))) %>%
    reduce(c)
  
  missing_data <- c(list_S_variable,list_C_variable) %>%
    setdiff(.,intersect(., data_ratio$variable)) %>%
    purrr::set_names() %>%
    imap(~data.frame(rep(0,length(unique(data_full$year))))%>%set_names(.y)) %>%
    reduce(cbind)
  
  data_ratio <- data_ratio %>%
              wide_data(variables = data_ratio$variable, out_format = "list") %>% 
    map(~cbind(.x,missing_data)) %>%
    long_data()
  
calcul_indic <- function(database){
  
  ### step 2: write de the function for the calculation 
calcul_sector_functions <- function(sector, data){

 res <- mutate(data,
               !!paste0("PHI_I_Y_",sector) := get(paste0("I_",sector))/get(paste0("Y_",sector)),
               !!paste0("PHI_FL_Y_",sector) := get(paste0("F_L_",sector))/get(paste0("Y_",sector)),
               !!paste0("PHI_FMAT_Y_",sector) := get(paste0("F_MAT_",sector))/get(paste0("Y_",sector)),
               !!paste0("PHI_FE_Y_",sector) := get(paste0("F_E_",sector))/get(paste0("Y_",sector)),
               !!paste0("PHI_FK_Y_",sector) := get(paste0("F_K_",sector))/get(paste0("Y_",sector)),
               !!paste0("PHI_FE_GDP_",sector) := get(paste0("F_E_",sector))/GDP,
               !!paste0("PHI_VAL_FK_Y_",sector) := get(paste0("F_K_",sector))*get(paste0("C_K_",sector))/
                                                  get(paste0("Y_",sector))*get(paste0("PY_",sector)),
               !!paste0("PHI_VAL_FL_Y_",sector) := get(paste0("F_L_",sector))*get(paste0("C_L_",sector))/
                                                  get(paste0("Y_",sector))*get(paste0("PY_",sector)),
               !!paste0("PHI_VAL_FE_Y_",sector) := get(paste0("F_E_",sector))*get(paste0("C_E_",sector))/
                                                  get(paste0("Y_",sector))*get(paste0("PY_",sector)),
               !!paste0("PHI_VAL_FMAT_Y_",sector) := get(paste0("F_MAT_",sector))*get(paste0("C_MAT_",sector))/
                                                    get(paste0("Y_",sector))*get(paste0("PY_",sector))
               ) %>%
      select(year,
             all_of(paste0("PHI_I_Y_",sector)),
             all_of(paste0("PHI_FL_Y_",sector)),
             all_of(paste0("PHI_FMAT_Y_",sector)),
             all_of(paste0("PHI_FE_Y_",sector)),
             all_of(paste0("PHI_FK_Y_",sector)),
             all_of(paste0("PHI_FE_GDP_",sector)),
             all_of(paste0("PHI_VAL_FK_Y_",sector)),
             all_of(paste0("PHI_VAL_FL_Y_",sector)),
             all_of(paste0("PHI_VAL_FE_Y_",sector)),
             all_of(paste0("PHI_VAL_FMAT_Y_",sector))
             )

  return(res)
}

calcul_commodity_functions <- function(commodity, data){

 res <- mutate(data,
               !!paste0("PHI_MGS_GDP_",commodity) := get(paste0("MGS_",commodity))/GDP,
               !!paste0("PHI_CI_GDP_",commodity) := get(paste0("CI_",commodity))/GDP,
               !!paste0("PHI_FE_GDP_",commodity) := get(paste0("F_E_",commodity))/GDP,
               !!paste0("PHI_CH_GDP_",commodity) := get(paste0("CH_",commodity))/GDP,
               !!paste0("PHI_G_GDP_",commodity) := get(paste0("G_",commodity))/GDP,
               !!paste0("PHI_I_GDP_",commodity) := get(paste0("I_",commodity))/GDP,
               !!paste0("PHI_X_GDP_",commodity) := get(paste0("X_",commodity))/GDP,
               !!paste0("PHI_M_GDP_",commodity) := get(paste0("M_",commodity))/GDP,
               !!paste0("BLC_TRADE_",commodity) := (get(paste0("X_",commodity))-get(paste0("M_",commodity)))/GDP,
               !!paste0("OPN_TRADE_",commodity) := (get(paste0("X_",commodity))+get(paste0("M_",commodity)))/GDP
               ) %>%
      select(year,
             all_of(paste0("PHI_MGS_GDP_",commodity)),
             all_of(paste0("PHI_CI_GDP_",commodity)),
             all_of(paste0("PHI_FE_GDP_",commodity)),
             all_of(paste0("PHI_CH_GDP_",commodity)),
             all_of(paste0("PHI_G_GDP_",commodity)),
             all_of(paste0("PHI_I_GDP_",commodity)),
             all_of(paste0("PHI_X_GDP_",commodity)),
             all_of(paste0("PHI_M_GDP_",commodity)),
             all_of(paste0("BLC_TRADE_",commodity)),
             all_of(paste0("OPN_TRADE_",commodity))
             )

  return(res)
}

### step 3: Line for one wide data base
data_res_sector <- toupper(names_sectors[,"code"]) %>%
  map(~calcul_sector_functions(sector = .x, data = database)) %>%
  reduce(full_join,by = "year")

data_res_commodity <- toupper(names_commodities[,"code"]) %>%
  map(~calcul_commodity_functions(commodity = .x, data = database) ) %>%
  reduce(full_join,by = "year")

data_res_agg <- database %>%
  mutate( #by sectors
PHI_FL_Y = F_L/Y,
PHI_FK_Y = F_K/Y,
PHI_I_Y = I/Y,
PHI_FMAT_Y = F_MAT/Y,
PHI_FE_Y = F_E/Y,
PHI_VAL_FK_Y = C_K*F_K/(PY*Y),
PHI_VAL_FL_Y = C_L*F_L/(PY*Y),
PHI_VAL_FE_Y = C_E*F_E/(PY*Y),
PHI_VAL_FMAT_Y = C_MAT*F_MAT/(PY*Y),

#PVA[s] non existing
# PHI_VAL_VA_Y = PVA*VA/(PY*Y),
# PHI_VAL_L_VA = C_L*F_L/(PVA*VA),
# PHI_VAL_PI_VA = 1 - C_L*F_L/(PVA*VA),

#by commodities
PHI_MGS_GDP = MGS/GDP,
PHI_CI_GDP = CI/GDP,
PHI_FE_GDP = F_E/GDP,
PHI_CH_GDP = CH/GDP,
PHI_G_GDP = G/GDP,
PHI_I_GDP = I/GDP,
PHI_X_GDP = X/GDP,
PHI_M_GDP = M/GDP,
BLC_TRADE = (X-M)/GDP,
OPN_TRADE = (X+M)/GDP,

#aggregated level
PHI_VAL_SPEND_G_GDP = SPEND_G_VAL/(PGDP*GDP),
PHI_VAL_INC_G_GDP = INC_G_VAL/(PGDP*GDP),
NTAXC_VAL = PNTAXC*NTAXC )

data_final <- cbind(data_res_commodity,data_res_sector,data_res_agg)

return(data_final)
}

data_ratio <- data_ratio %>% 
  wide_data(variables = data_ratio$variable , out_format = "list") %>%  
  map(~calcul_indic(.x)) %>% 
  long_data()

```

```{r Function to visualise indicators with detail and aggregated sector/commodity}

plot_ratio <- function(data, 
                       indicator = NULL, 
                       years = NULL, 
                       title = "", 
                       scenario = NULL)
{

### Inputs check
  if(length(indicator) > 1 ){
    stop(message("Please choose only one indicator each time. \n"))
  }else if(is.null(indicator)){
    stop(message("Please choose one indicator. \n"))
  }else if(!TRUE %in% grepl(paste0("^",indicator,"_"), data$variable)){
    stop(message("Indicator does not exist, please choose another one. \n"))
  }
  
  if(length(years) > 1 ){
    stop(message("Please choose only one year each time. \n"))
  }else if(is.null(years)){
    years <- 2019
  }
  
  if(length(scenario) > 1 ){
    stop(message("Please choose only one scenario each time. \n"))
  }else if(is.null(scenario)){
    scenario <- "baseline"
  }else if(!TRUE %in% grepl(scenario, names(data))){
    stop(message("Scenario does not exist, please choose another one. \n"))
  }
  
### Code list for regroup the detailed sector/commodity

code_list <- bridge_sectors %>%
  imap(~data_frame(name = toupper(.x), code = .y) %>% as.data.frame()) %>%
  reduce(rbind) %>%
  rbind(c("S001","S001"),c("S002","S002"),c("S003","S003"),c("S004","S004"),
        c("S005","S005"),c("S006","S006"),c("S007","S007"),c("S008","S008"),
        c("C001","C001"),c("C002","C002"),c("C003","C003"),c("C004","C004"),
        c("C005","C005"),c("C006","C006"),c("C007","C007"),c("C008","C008")) %>%
  rbind(
    bridge_commodities %>%
    imap(~data_frame(name = toupper(.x), code = .y) %>% as.data.frame()) %>%
    reduce(rbind)) %>%
  left_join(rbind(tail(names_commodities,8),tail(names_sectors,8)) %>% 
              set_names(c("facet_by","code")), by = "code")

### Preparation of data base
data_fig <- data %>% 
            filter(grepl(paste0("^",indicator,"_[A-Z0-9]{4}$"),variable), year == years)

### Matching detailed sector with aggregated sector
data_fig <- data_fig %>% mutate(name = case_when(
            str_extract(data_fig$variable,"C[A-Z0-9]{3}$|S[A-Z0-9]{3}$") %in% code_list$name 
                       ~str_extract(data_fig$variable,"C[A-Z0-9]{3}$|S[A-Z0-9]{3}$"))) %>% 
            left_join(code_list, by = "name") %>% as.data.frame()

### Plot drawing
fig <- ggplot(data_fig, aes(x = name, y = get(scenario), fill = facet_by, group = facet_by)) + 
       geom_bar(stat = "identity") +
       scale_fill_manual("Sector/Commodity",values = custom.palette(8) ) +
       ylab(scenario) +
       xlab("") +
       ggtitle(title) +
       facet_grid(~facet_by, scales = "free_x", space = "free_x") +
       theme(axis.text.x = element_text(angle = 45))

return(fig)
}

```

```{r Example}

fig <- plot_ratio(data = data_ratio, indicator = "PHI_VAL_FE_Y", years = 2019, title = "Energy cost (in value) over production  (in value)", scenario = "baseline")

fig
```

